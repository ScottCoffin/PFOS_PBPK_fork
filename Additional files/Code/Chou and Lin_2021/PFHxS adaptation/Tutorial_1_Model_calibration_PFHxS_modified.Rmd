---
title: "Tutorial_1_Model calibration for rats"
author: "Scott Coffin"
advisor: "Anatoly Soshilov"
date: "July 28, 2025"
fontsize: 12pt
output:
  html_document:
    theme: cerulean
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width = 13, fig.height = 10) 
```

# Setup
## Libraries
```{r load-PFHxS-data, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(FME)
library(mrgsolve)    ## R-package for Loading mrgsolve code   
library(magrittr)    ## R-package for the pipe, %>% ,  
library(dplyr)       ## R-package for transform and summarize tabular data with rows and columns; %>% 
library(tidyverse)   ## R-package for transform and summarize tabular data with rows and columns; %>% 
library(ggplot2)     ## R-package for GGplot  
library(FME)         ## R-package for model fitting  
library(minpack.lm)  ## R-package for model fitting 
```

## Read mrgsolve-based PBPK Model R file
The rat pre-pregnant, gestational and lactational PBPK model were written in `RMod.R` file. Before compiling the model, please call this file using R function `source`. 
```{r}
# PFOS code
#source(file = "Additional files/Code/Chou and Lin_2021/ModFit/Rat/RMod.R") ## input the rat gestational model

# PFHxS code
source(file = "Additional files/Code/Chou and Lin_2021/PFHxS adaptation/RMod_PFHxS.R") ## input the rat gestational model
```

## Build mrgsolve-based PBPK Model
Read the code and build these mrgsolve-based PBPK models. You should make sure all models are built correctly. 
```{r}
PreGmod_R <- mcode ("PreG_RatPBPK.code", PreG_RatPBPK.code) # bulid the pre-pregnant model
Gmod_R <- mcode ("GRatPBPK.code", GRatPBPK.code) # bulid the gestational model (not used)
Lmod_R <- mcode ("LRatPBPK.code", LRatPBPK.code) # bulid the lactational model
```

## O'Shaugnessy et al. (2024) data
The data collected from [O'Shaugnessy et al. (2024)](https://doi.org/10.1016/j.envint.2024.108838)
Study design:

- Dose regimen: 0, 17, 50 mg/kg/day.<br>
- Exposure duration: GD2 - PN14.<br>
- Abbreviation: maternal plasma (MP), fetal plasma (FP), milk band (MB)<br>
- All units are in ug/mL.<br>
```{r}
# Load PFHxS data from O'Shaughnessy et al. (2024)
Data_0 <- read.csv("Additional files/Code/Chou and Lin_2021/PFHxS adaptation/rat_serum_data.csv") %>%
  mutate(Study_desc = Study) %>% 
  mutate(Study = case_when(Study_desc == "O'Shaugnessy 2024" ~ 1)) %>% 
  mutate(
    type = case_when(
      Sample == "FP" ~ "Pup",
      Sample == "MP" ~ "Dam",
      Sample == "MB" ~ "Milk"
    ))
```


```{r plot-observed-data}
ggplot(Data_0, aes(x = Time, y = Conc, color = type)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = Conc - SD, ymax = Conc + SD), width = 5) +
  facet_wrap(~Dose) +
  labs(title = "Observed PFHxS concentrations from O'Shaughnessy (2024)",
       x = "Time (hr)", y = "PFHxS (Âµg/mL)") +
  theme_bw()
```

<!-- # Model calibration for the gestational PBPK model -->
<!-- O'Shaughnessy et al did not measure serum concentrations during the gestational period in either the dams or the pups. They did, however, measure serum concentrations in pups on PN0. -->
<!-- ```{r} -->
<!-- ## The datasets were filtered based on Study, Dose, Time  -->
<!-- ## and selected by the column of "Time" and "Conc". -->
<!-- ### Extract fetal plasma concentrations at PN0 (i.e., day of birth, before lactation) -->
<!-- OBS.A1  <- Data_0 %>% filter(Study == 1 & Sample == "FP" & Dose == 17 & Time == 528) %>% select(Time = "Time", CFP = "Conc") #fetal plasma -->
<!-- OBS.A2  <- Data_0 %>% filter(Study == 1 & Sample == "FP" & Dose == 50 & Time == 528) %>% select(Time = "Time", CFP = "Conc") #fetal plasma -->
<!-- ``` -->

<!-- ## Define the prediction function for the gestational model calibration -->
<!-- Here, we define a prediction function to simulate the time-varying profiles of PFOS based on the study design of Thibodeaux et al., 2003. You can obtain the predicted values of maternal plasma (MP) and liver (ML), and fetal liver (FL) by running this prediction function. -->

<!-- ```{r} -->
<!-- ## Define the prediction function based on the study design of the literature of Thibodeaux et al., 2003 -->
<!-- ## Exposure scenario: Dosing druing pregnnacy from GD2 - GD20 -->
<!-- pred.A <- function(Gpars, DOSE) { ## Gpars: input parameters, Dose: input dose,  -->

<!--     ## Get out of log domain -->
<!--     Gpars <- exp(Gpars)                   ## Return a list of exp from log scale -->

<!--     ## Exposure scenario for gestational exposure -->
<!--     GBW          = 0.225                  ## Default value: 0.225-0.307 kg; Loccisano et al. (2012);  -->
<!--     tinterval    = 24                     ## Time interval;  -->
<!--     GTDOSE       = 20                     ## Total dosing/Dose times;  -->
<!--     GDOSE        = DOSE                   ## Input oral dose   -->
<!--     GDOSEoral    = GDOSE*GBW              ## Amount of oral dose -->

<!--     ## To create a data set of 1 subject receiving DOSEoral every 24 hours -->
<!--     Gex.oral <- ev (ID   = 1,             ## One individual -->
<!--                     time = 24*2,          ## Dosing starts at GD2 -->
<!--                     amt  = GDOSEoral,     ## Amount of dose  -->
<!--                     ii   = tinterval,     ## Time interval -->
<!--                     addl = GTDOSE - 1,    ## Addtional dosing  -->
<!--                     cmt  = "AST",         ## The dosing comaprtment: AST Stomach   -->
<!--                     tinf = 0.01,          ## Infusion time;   -->
<!--                     replicate = FALSE)    ## No replicate -->

<!--     Gtsamp  = tgrid(0, tinterval*(GTDOSE - 1) + 24*2, 1) ## set up the output time; dtout = 1 hours  -->

<!--     ## Simulation of exposure scenaior  -->
<!--     Gout <-  -->
<!--     Gmod_R %>% ## Gestational PBPK model -->
<!--     param (Gpars) %>% ## Update the parameter list with Gpars -->
<!--     update(atol = 1E-6, maxsteps = 500000) %>%  ## Atol:tolerance parameter; maxsteps:maximum steps -->
<!--     mrgsim_d (data = Gex.oral, tgrid = Gtsamp)    -->

<!--     ## Extract the "Time", "CPlas", "CL" and "CFL" from Gout;  -->
<!--     Goutdf = cbind.data.frame(Time   = Gout$time,      # Time : output time (hours) -->
<!--                               CFP  = Gout$Plasma_Fet#,    # CPlas: PFHxS concentration in fetus plasma -->
<!--                               #CL     = Gout$Liver,     # CL: PFOS concentration in maternal liver -->
<!--                               #CFL    = Gout$Liver_Fet -->
<!--                               ) # CFL: PFOS concentration in fetal liver -->

<!--     Goutdf <- Goutdf %>% filter (Time > 0)  # filter the value at time = 0 -->
<!--     return (Goutdf) # Return Goutdf -->
<!-- } -->
<!-- ``` -->

<!-- ## Create a cost function for gestational model calibration  -->
<!-- Define a cost function `Gcost` to estimate the model residual. <br> -->
<!-- The `modCost` function (from FME package) given a solution of a model and observed data, estimates the residuals, and the variable and model costs (sum of squared residuals).<br> -->
<!-- Note: -->

<!-- - `model`: model output; input the simulation value.<br>  -->
<!-- - `obs`: input the observed data.<br> -->
<!-- - `cost`: if not NULL, the output of a previous call to modCost; in this case, the new output will combine both. -->

<!-- ```{r} -->
<!-- Gcost<-function (pars){ -->
<!--     outdf.A1 <- pred.A (Gpars = pars,  DOSE = 17) -->
<!--     outdf.A2 <- pred.A (Gpars = pars,  DOSE = 50) -->

<!--     cost<- modCost  (model = outdf.A1, obs = OBS.A1,  x ="Time") -->
<!--     cost<- modCost  (model = outdf.A2, obs = OBS.A2,  x ="Time", cost = cost) -->

<!--     return(cost) -->
<!-- } -->
<!-- ``` -->
<!-- ## List the initial parameters for later used in sensitivity analysis -->
<!-- All the values of parameters are initial values before optimization from Chou and Lin (2019). -->

<!-- ```{r} -->
<!-- Gtheta.int <- log(c( -->
<!--     Vmax_baso_invitro              = 393.45,                       -->
<!--     Km_baso                        = 27.2,                         -->
<!--     Vmax_apical_invitro            = 1808,                         -->
<!--     Km_apical                      = 278,                         -->
<!--     RAFbaso                        = 1.90,                         -->
<!--     RAFapi                         = 4.15,                        -->
<!--     Kdif                           = 5.1e-4,                        -->
<!--     KeffluxC                       = 2.09,                         -->
<!--     KbileC                         = 0.0026,                        -->
<!--     KurineC                        = 1.60,                         -->
<!--     Free                           = 0.022,                         -->
<!--     PL                             = 3.66,                         -->
<!--     PK                             = 0.8,                          -->
<!--     PM                             = 0.16, -->
<!--     PF                             = 0.13, -->
<!--     PRest                          = 0.22,                          -->
<!--     PPla                           = 0.41, -->
<!--     K0C                            = 1,                            -->
<!--     Kabsc                          = 2.12,                         -->
<!--     KunabsC                        = 7.05e-5,                      -->
<!--     Ktrans1C                       = 0.46, -->
<!--     Ktrans2C                       = 1, -->
<!--     Ktrans3C                       = 0.008, -->
<!--     Ktrans4C                       = 0.001, -->
<!--     Free_Fet                       = 0.022, -->
<!--     PL_Fet                         = 3.66, -->
<!--     PRest_Fet                      = 0.22 -->
<!-- )) -->
<!-- ``` -->

<!-- ## Sensitivity function  -->
<!-- ```{r} -->
<!-- ## senFun is the sensitivity analysis function in FME -->
<!-- SnsPlasma <- sensFun(func = Gcost, parms = Gtheta.int, varscale = 1)  -->
<!-- Sen       <- summary(SnsPlasma) ## summary the rsults of sensitivity analysis -->
<!-- plot(summary(SnsPlasma)) ## plot the results of sensitivity analysis -->
<!-- ``` -->

<!-- ## Select sensitive parameters -->

<!-- ```{r} -->
<!-- Gtheta <- Gtheta.int[abs(Sen$Mean) > 1.2*mean(abs(Sen$Mean))] -->
<!-- Gtheta  -->
<!-- ``` -->

<!-- ## Select sensitive parameters and relevant parameters -->
<!-- Since the Levenberg-Marquardt-algorithm is a gradient-based optimization, the identification of a global optimum cannot be guaranteed. We hence selected the sensitive parameters and a few parameters that were relevant to calibrated datasets in order to obtain good initial guesses for the optimization.   -->

<!-- ```{r} -->
<!-- ## Selected parameters -->
<!-- Gtheta <- log(c( -->
<!--     Vmax_baso_invitro              = 393.45,                       -->
<!--     #Km_baso                        = 27.2,                         -->
<!--     #Vmax_apical_invitro            = 1808,                         -->
<!--     Km_apical                      = 278,                         -->
<!--     #RAFbaso                        = 1.90,                         -->
<!--     #RAFapi                         = 4.15,                        -->
<!--     #Kdif                           = 5.1e-4,                        -->
<!--     #KeffluxC                       = 2.09,                         -->
<!--     KbileC                         = 0.0026,                        -->
<!--     #KurineC                        = 1.60,                         -->
<!--     Free                           = 0.022,                         -->
<!--     PL                             = 3.66,                         -->
<!--     #PK                             = 0.8,                          -->
<!--     #PM                             = 0.16, -->
<!--     #PF                             = 0.13, -->
<!--     #PRest                          = 0.22,                          -->
<!--     #PPla                           = 0.41, -->
<!--     #K0C                            = 1,                            -->
<!--     #Kabsc                          = 2.12,                         -->
<!--     #KunabsC                        = 7.05e-5,                      -->
<!--     Ktrans1C                       = 0.46, -->
<!--     #Ktrans2C                       = 1, -->
<!--     Ktrans3C                       = 0.008, -->
<!--     #Ktrans4C                       = 0.001, -->
<!--     #Free_Fet                       = 0.022, -->
<!--     PL_Fet                         = 3.66, -->
<!--     PRest_Fet                      = 0.22 -->
<!-- )) -->

<!-- ``` -->

<!-- ## Least squares fit using levenberg-marquart algorithm -->
<!-- The code `modFit` is the function fitting a model to data.<br> -->
<!-- The component of function: <br> -->
<!--    - `f`: a function to be minimized; here you need to input the cost function defined above.<br> -->
<!--    - `p`: initial values for the parameters to be optimized over.<br> -->
<!--    - `method`: fitting method; here we choose the levenberg-marquart algorithm ("Marq").<br> -->
<!--    - `control`: additional control arguments - see details of nls.lm ("Marq").<br> -->

<!-- ```{r} -->
<!-- GFit <- modFit(f = Gcost, p = Gtheta, method ="Marq", -->
<!--                control = nls.lm.control(nprint = 1)) -->
<!-- ``` -->

<!-- ## Summary of fitting results -->
<!-- The model calibration has completed; Now you can check the fitting results and check the parameter values -->
<!-- ```{r} -->
<!-- summary(GFit)    ## Summary of fitting results  -->
<!-- exp(GFit$par)    ## Converted the log-tranfromed parameters to arithmetic values -->
<!-- ``` -->

<!-- ## Check your results -->
<!-- ```{r warning=FALSE} -->
<!-- Gcost(GFit$par) -->
<!-- ``` -->



# Model calibration for the lactational PBPK model
```{r}
## Read the data and later used in model calibration
## Filter the dataset and get the samples during lactation
# maternal plasma
OBS.MP1  <- Data_0 %>% filter(Study == 1 & Sample == "MP" & Dose == 17)  %>% select(Time = "Time", CPlas = "Conc")
OBS.MP2  <- Data_0 %>% filter(Study == 1 & Sample == "MP" & Dose == 50)  %>% select(Time = "Time", CPlas = "Conc")
# fetal plasma
OBS.FP1  <- Data_0 %>% filter(Study == 1 & Sample == "FP" & Dose == 17)  %>% select(Time = "Time", CPlas_pup = "Conc")
OBS.FP2  <- Data_0 %>% filter(Study == 1 & Sample == "FP" & Dose == 50)  %>% select(Time = "Time", CPlas_pup = "Conc")
# Load milk band observations
OBS.MB1 <- Data_0 %>% filter(Study == 1 & Sample == "MB", Dose == 17)   %>%  select(Time = "Time", CMilk = "Conc")
OBS.MB2 <- Data_0 %>% filter(Study == 1 & Sample == "MB", Dose == 50)   %>%  select(Time = "Time", CMilk = "Conc")
```

## Define the prediction function for the lactational model calibration
```{r}
## Exposure scenario B. Dosing from GD0 - PND20;
pred.B <- function(Lpars, DOSE) {
    
## Get out of log domain
#Gpars <- lapply(GFit$par, exp)## Return a list of exp (parametrs for gestational model) from log scale

# ## Exposure scenario for gestational exposure
# GBW          = 0.225                  ## Default value: 0.225-0.307 from Loccisano et al. (2012); 
# tinterval    = 24                     ## Time interval; 
# GTDOSE       = 20                     ## Total dosing/Dose times; Repeat oral dose from GD2 - GD22 (estimated to have given birth at D =22 - not reported in O'Shaugnessy)
# GDOSE        = DOSE                   ## Input oral dose  
# GDOSEoral    = GDOSE*GBW              ## Amount of oral dose
#     
# ## To create a data set of 1 subject receiving DOSEoral every 24 hours 
# Gex.oral <- ev (ID   = 1,             ## One individual
#                 amt  = GDOSEoral,     ## Amount of dose 
#                 ii   = tinterval,     ## Time interval
#                 addl = GTDOSE - 1,    ## Addtional dosing 
#                 cmt  = "AST",         ## The dosing compartment: AST Stomach  
#                 tinf = 0.01,          ## Infusion time;  
#                 replicate = FALSE)    ## No replicate
#     
# Gtsamp  = tgrid(0, tinterval*(GTDOSE - 1) + 24*1, 1) ## set up the output time; dtout = 1 hours 
#     
# ## Simulation of exposure scenario during gestation (oral repeated dose to 0.1, 0.3, 1 mg/kg)
# Gout <- 
#     Gmod_R %>%
#     param (Gpars) %>%
#     update(atol = 1E-6, maxsteps = 50000) %>%          
#     mrgsim_d (data = Gex.oral, tgrid = Gtsamp)
#     
# Goutdf = cbind.data.frame(Time      = Gout$time,       # Output time (hours)
#                           CPlas     = Gout$Plasma,     # Maternal plasma
#                           CL        = Gout$Liver,      # Maternal liver
#                           CPlas_pup = Gout$Plasma_Fet, # Fetal plasma
#                           CL_pup    = Gout$Liver_Fet)  # Fetal liver

# Extract the predicted values at GD21 and then used as initial values of the lactational model
# Init <- Gout %>% filter (time == 21*24) %>% 
#         select(-c("AUC_CPlas","AUC_CPlas_Fet", "Plasma", "Liver", "Plasma_Fet", "Liver_Fet"))


##########################################################################################################################
##### Use initial measured plasma concentrations in pups as starting conditions due to lack of gestational model/data
##########################################################################################################################
  # Extract PN0 pup serum concentrations
PN0_pup <- Data_0 %>%
  filter(Sample == "FP", Time == 528) %>%
  group_by(Dose) %>%
  summarise(serum_conc_ugml = mean(Conc, na.rm = TRUE))

f_unbound = 0.0016364 # 10.3390/toxics12090672

# Plasma volume assumptions (mL)
V_plasma_pup <- 4   # mL, newborn rat pup
V_plasma_dam <- 13  # mL, adult lactating dam

# Compute initial amounts (Âµg)
PN0_pup <- PN0_pup %>%
  mutate(
    APlas_pup = serum_conc_ugml * V_plasma_pup * f_unbound,
    APlas_dam = serum_conc_ugml * V_plasma_dam * f_unbound * 0.25  # assume 25% of pup level
  )
  
# Use robust dose matching
  dose_match <- PN0_pup$Dose[which.min(abs(PN0_pup$Dose - DOSE))]

  # Extract measured PN0 pup values
  APlas_free_pup <- PN0_pup$APlas_pup[PN0_pup$Dose == dose_match]
  APlas_free     <- PN0_pup$APlas_dam[PN0_pup$Dose == dose_match]

  # Use proportional allocations based on APlas_free
  Init <- list(
    time             = 528, #time at PN0
    APlas_free       = APlas_free,
    APTC             = 0.01 * APlas_free,
    AFil             = 0.01 * APlas_free,
    AKb              = 0.05 * APlas_free,
    ARest            = 0.1  * APlas_free,
    AL               = 0.2  * APlas_free,
    AM               = 0.05 * APlas_free,
    AF               = 0.05 * APlas_free,
    A_baso           = 0.01 * APlas_free,
    A_apical         = 0.01 * APlas_free,
    Adif             = 0.01 * APlas_free,
    Aefflux          = 0.01 * APlas_free,
    APlas_Fet_free   = APlas_free_pup,
    AL_Fet           = 0.1 * APlas_free_pup,
    ARest_Fet        = 0.05 * APlas_free_pup
  )

# check if Init is OK to go
stopifnot(all(sapply(Init, is.numeric)))
stopifnot(all(sapply(Init, function(x) length(x) == 1)))
stopifnot(!any(is.na(unlist(Init))))

  
## Exposure scenario for Lactational exposure; through PND0 - PND21 (end of lactation)
LBW          = 0.242                  ## Body weight; 0.242-0.292 from Loccisano et al. (2012); 
tinterval    = 24                     ## Time interval; 
LTDOSE       = 22                     ## Total dosing/Dose times; Repeated oral dose from PND0 - PND21
LDOSE        = DOSE                   ## Repeated oral dose (17, 50 mg/kg);  
LDOSEoral    = LDOSE*LBW              ## Amount of oral dose
    
    
# To create a data set of 1 subject receiving DOSEoral.A every 24 hours
Lex.oral <- ev (ID   = 1,            ## One individual
                amt  = LDOSEoral,    ## Amount of dose 
                ii   = tinterval,    ## Time interval
                addl = LTDOSE - 1,   ## Addtional doseing 
                cmt  = "AST",        ## The dosing comaprtment: AST Stomach  
                tinf = 0.01,         ## Infusion time;  
                replicate = FALSE)   ## No replicate
    
Ltsamp       = tgrid(0, tinterval*(LTDOSE - 1) + 24*2, 1) ## Simulation time from PND0 to PND21 with dosing of 1 + (LTDOSE - 1) + 2 days (No dosing)

# get lactational params out of log10 domain
Lpars <- lapply(Lpars, exp) 
    
## The concentration at the end of gestation used as initial concentration of lactation model 
Lout <- Lmod_R %>% 
       init(APlas_free = Init$APlas_free, APTC = Init$APTC, AFil = Init$AFil, 
              AKb = Init$AKb, ARest = Init$ARest, AL = Init$AL, AM = Init$AM, AF = Init$AF, 
              A_baso = Init$A_baso, A_apical = Init$A_apical, Adif = Init$Adif, Aefflux = Init$Aefflux,   
              APlas_free_pup = Init$APlas_Fet_free, AL_pup = Init$AL_Fet, ARest_pup = Init$ARest_Fet) %>%
        param (Lpars) %>%
        update(atol = 1E-6, maxsteps = 500000) %>%          
        mrgsim_d (data = Lex.oral, tgrid = Ltsamp) 
    
Loutdf = cbind.data.frame(Time   = Lout$time + 22*24,   # Simulation time + GD22 (22*24 hours)
                          CPlas  = Lout$Plasma,         # Maternal plasma
                          CPlas_pup = Lout$Plasma_pup,  # Neonatal palsma
                          CMilk = Lout$Milk
                          )
    
return (Loutdf)
}

```

## Create a cost function for lactational model calibration 
Define a cost function `Lcost` to estimate the lactational model residual. 

```{r}
## Estimate the model residual by modCost function
Lcost<-function (pars){
    outdf.A <- pred.B (Lpars = pars,  DOSE = 17)
    outdf.B <- pred.B (Lpars = pars,  DOSE = 50)
    
    # maternal plasma
    cost<- modCost  (model = outdf.A, obs = OBS.MP1, x ="Time")
    cost<- modCost  (model = outdf.B, obs = OBS.MP2, x ="Time", cost = cost)
    # fetal plasma
    cost<- modCost  (model = outdf.A, obs = OBS.FP1, x ="Time", cost = cost)
    cost<- modCost  (model = outdf.B, obs = OBS.FP2, x ="Time", cost = cost)
    # milk band (stomach contents)
    cost <- modCost (model = outdf.A, obs = OBS.MB1, x = "Time", cost = cost)
    cost <- modCost (model = outdf.B, obs = OBS.MB2, x = "Time", cost = cost)
    
    return(cost)
}

```

## List the inital parameter for the later used in senstivity anlaiysis
All the values of parameters are initial values before optimization from Chou and Lin (2019) and Loccisano et al. (2012).
```{r}
## initial parmaeters for the lactational model
Ltheta.int <- log(c(
    Vmax_baso_invitro              = 393.45,
    Km_baso                        = 27.2,
    Vmax_apical_invitro            = 4164, #pmol/min/mg protein, Fragki et al (2023)
    Km_apical                      = 278,
    RAFbaso                        = 1.90,
    RAFapi                         = 4.15,
    KeffluxC                       = 2.09,
    KbileC                         = 0.0026,
    KurineC                        = 1.6,
    Free                           = 0.0008, #Kim et al., 2018 (ultrafiltration showed <0.08% unbound)
    PL                             = 0.11, #Kim et al., 2016 (female rat, 14 days post-dose)
    PK                             = 0.08, #Kim et al., 2016 (female rat, 14 days post-dose)
    PM                             = 0.16,
    PF                             = 0.14, #Iulini et al., 2024 (assumed based on PFOS in PBPK model)
    PRest                          = 0.2, # Iulini et al., 2024 (value based on PFOS, used for PFHxS model)
    PMilkM                         = 1.9,
    PMilkP                         = 0.007, #Haug et al., 2011 (human breast milk vs plasma; PFHxS M:P â0.007:1)
    PAMilkC                        = 0.5,
    K0C                            = 1,
    KabsC                          = 2.12,
    KunabsC                        = 7.05e-5,
    Kdif                           = 5.1e-4,
    KMilk0                         = 0.0268, #Loccisano et al., 2012 (rat PBPK model assumption for lactation)
    Free_pup                       = 0.022,
    PL_pup                         = 3.66,
    PK_pup                         = 0.8,
    PRest_pup                      = 0.22,
    KabsC_pup                      = 2.12,
    KbileC_pup                     = 0.35,
    KurineC_pup                    = 1.6,
    KeffluxC_p                     = 2.09,
    Kdif_pup_0                     = 0.001,
    Vmax_baso_invitro_p            = 393.45,
    Km_baso_p                      = 27.2,
    Vmax_apical_invitro_p          = 4164, #Fragki
    Km_apical_p                    = 278
))

```

## Sensivity analysis
```{r}
SnsPlasma <- sensFun(func = Lcost, parms = Ltheta.int, varscale = 1)
Sen       <- summary(SnsPlasma)
plot(summary(SnsPlasma))
```

## Select senstive parameters; 
```{r}
Ltheta <- Ltheta.int[abs(Sen$Min) > 1.5*mean(abs(Sen$Min))]
Ltheta 
```

## Select senstive parameters and relavant parameters based on available data
```{r}
Ltheta <- log(c(
    #Vmax_baso_invitro              = 393.45,
    #Km_baso                        = 27.2,
    Vmax_apical_invitro            = 4164,
    #Km_apical                      = 278,
    #RAFbaso                        = 1.90,
    #RAFapi                         = 4.15,
    #KeffluxC                       = 2.09,
    #KbileC                         = 0.0026,
    #KurineC                        = 1.6,
    Free                           = 0.0008,
    PL                             = 0.11,
    #PK                             = 0.8,
    #PM                             = 0.16,
    #PF                             = 0.13,
    PRest                          = 0.2,
    PMilkM                         = 1.9,
    #PMilkP                         = 0.11,
    #PAMilkC                        = 0.5,
    #K0C                            = 1,
    #KabsC                          = 2.12,
    #KunabsC                        = 7.05e-5,
    #Kdif                           = 5.1e-4,
    KMilk0                         = 0.0268,
    #Free_pup                       = 0.022,
    PL_pup                         = 3.66
    #PK_pup                         = 0.8,
    #PRest_pup                      = 0.22
    #KabsC_pup                      = 2.12,
    #KbileC_pup                     = 0.0026,
    #KurineC_pup                    = 1.6
    #KeffluxC_p                     = 2.09,
    #Kdif_pup_0                     = 0.001,
    #Vmax_baso_invitro_p            = 393.45,
    #Km_baso_p                      = 27.2,
    #Vmax_apical_invitro_p          = 1808
    #Km_apical_p                    = 278
))
```
## Least squares fit using levenberg-marquart algorithm
```{r}
LFit <- modFit(f = Lcost, p = Ltheta, method ="Marq",
               control = nls.lm.control(nprint = 1))
```

## Summary of fitting results
The model calibration has completed; Now you can check the fitting results and check the parameter values
```{r}
summary(LFit)    ## Summary of fitting results 
exp(LFit$par)    ## Converted the log-tranfromed parmaeters to arithmetic value
```

## Check your results
```{r warning=FALSE}
Lcost(LFit$par)
```


# Save results
You can use the function `saveRDS()`save the fitting results to RDS files. 

```{r eval=FALSE}
#saveRDS(GFit, file  ='GFit_rat.rds')    # Save the fitting results for gestational PBPK model
#saveRDS(LFit, file  ='LFit_rat.rds')   # Save the fitting results for lactational PBPK model
```



## Visualization of PFHxS model predictions vs. observations
```{r}
# Predict for both dose groups using fitted parameters
sim_17 <- pred.B(LFit$par, DOSE = 17) %>% mutate(Dose = "17 mg/kg")
sim_50 <- pred.B(LFit$par, DOSE = 50) %>% mutate(Dose = "50 mg/kg")
sim_all <- bind_rows(sim_17, sim_50)

# Add compartment label for plotting
sim_long <- sim_all %>%
  pivot_longer(cols = c(CPlas, CPlas_pup, CMilk), names_to = "Compartment", values_to = "Conc_pred") %>%
  mutate(Compartment = case_when(
    Compartment == "CPlas" ~ "Dam serum (model)",
    Compartment == "CPlas_pup" ~ "Pup serum (model)",
    Compartment == "CMilk" ~ "Milk band (model)"
  ))

# Prepare observed data
OBS.MP1$Compartment <- "Dam serum (obs)"
OBS.MP2$Compartment <- "Dam serum (obs)"
OBS.FP1$Compartment <- "Pup serum (obs)"
OBS.FP2$Compartment <- "Pup serum (obs)"
OBS.MB1$Compartment <- "Milk band (obs)"
OBS.MB2$Compartment <- "Milk band (obs)"

OBS.MP1$Dose <- "17 mg/kg"
OBS.MP2$Dose <- "50 mg/kg"
OBS.FP1$Dose <- "17 mg/kg"
OBS.FP2$Dose <- "50 mg/kg"
OBS.MB1$Dose <- "17 mg/kg"
OBS.MB2$Dose <- "50 mg/kg"

# Merge observed
obs_all <- bind_rows(
  OBS.MP1 %>% rename(Conc = CPlas),
  OBS.MP2 %>% rename(Conc = CPlas),
  OBS.FP1 %>% rename(Conc = CPlas_pup),
  OBS.FP2 %>% rename(Conc = CPlas_pup),
  OBS.MB1 %>% rename(Conc = CMilk),
  OBS.MB2 %>% rename(Conc = CMilk)
)

custom_colors <- c(
  "Dam serum (model)" = "#1f77b4",
  "Dam serum (obs)"   = "#1f77b4",
  "Pup serum (model)" = "#d62728",
  "Pup serum (obs)"   = "#d62728",
  "Milk band (model)" = "#2ca02c",
  "Milk band (obs)"   = "#2ca02c"
)


# Plot
ggplot() +
  geom_line(data = sim_long, aes(x = Time, y = Conc_pred, color = Compartment), linewidth = 1) +
  geom_point(data = obs_all, aes(x = Time, y = Conc, color = Compartment, shape = Compartment), size = 6, alpha = 1) +
  scale_color_manual(values = custom_colors) +
  scale_x_continuous(limits = c(530, 1000)) +
  scale_y_continuous(limits = c(0, 225)) +
  facet_wrap(~Dose) +
  labs(title = "PFHxS Model Predictions vs. Observed Serum and Milk Band Data",
       x = "Time (hr)", y = "PFHxS (Âµg/mL)") +
  theme_bw(base_size = 15) +
  theme(legend.position = "bottom") 
```


